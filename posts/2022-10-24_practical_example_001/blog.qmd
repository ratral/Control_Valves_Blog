---
title: "Example: Flow coefficient and cavitation value"
subtitle: "(Draft!!!!)"
author: "Dr. Raúl Trujillo Álvarez"
date: "2022-10-24"
categories: [hydraulics, theory, valves, analysis, example]
description: ''
execute: 
  message: false
  warning: false
  echo: false
editor_options: 
  chunk_output_type: console
---

```{r}
library(tidyverse)
library(gt)
library(hyd4gpv)

# IMPUT DATA
## Parameters of the Project
data <- list(
  medium        = "Raw Water",
  temp          = 15,      # Water temperature in °C
  masl          = 1780,    # meters above sea level
  dn            = 200,     # Diameter of the RIKO valve en mm
  d1            = 200,     # Diameter of the Pipe Upstream in mm
  d2            = 200,     # Diameter of the Pipe Downstream in mm
  add_factor    = 1.3      # The factor of safety for the Kv, this must be >= 1 
)


## base_data 
###  - Pressures in bar
###  - Flow in m3/h

data$operation <- tribble(
    ~condition,  ~p1,   ~p2,  ~flow,
    "01.max",	 4.439,	2.615,	396.0,
    "02.max",	18.263,	5.241,	396.0,
    "03.max",	 9.455,	2.615,	396.0,
    "04.max",	20.215,	2.190,	396.0,
    "05.max",	19.903,	2.190,	396.0,
    "06.max",	19.132,	2.190,	396.0,
    "07.max",	18.534,	2.347,	396.0,
    "08.max",	17.439,	2.347,	396.0,
    "09.max",	17.148,	2.347,	396.0,
    "10.max",	18.314,	2.718,	396.0,
    "01.min",	 4.368,	2.249,	252.0,
    "02.min",	18.193,	5.077,	252.0,
    "03.min",	 9.337,	2.249,	252.0,
    "04.min",	20.185,	2.081,	252.0,
    "05.min",	19.873,	2.081,	252.0,
    "06.min",	19.100,	2.081,	252.0,
    "07.min",	18.470,	2.148,	252.0,
    "08.min",	17.372,	2.148,	252.0,
    "09.min",	17.081,	2.148,	252.0,
    "10.min",	18.299,	2.291,	252.0
    
  ) 

# Calculation input data characteristics
base_data <- data$operation |>  
  hyd4gpv::points_cloud_param(data$dn, data$masl, data$temp) |> 
  arrange(condition, flow)
```


# Sizing sample

These blog notes provide a simplified procedure for sizing control valves at standard service conditions. The data required to size a valve, such as nominal size, gauge pressures, and flow rates, are actual values of a project.

Initially, I would like to make a first approximation to the selection process of the control valve. Later, in other blogs, I will analyze the different cases. 

![Operating data (Source: Wagner, Walter. Regel- und Sicherheitsarmaturen.)](control_valve_01.png)


## Flowchart of the valve selection process.

```{mermaid}
flowchart TD
  A[Hydraulic Model] --> B(1. CV \n data operation)
  A --> E
  B --> C(2. Select min. Kv \n that the CV must supply)
  C--> H
  
  E[Valve DN, PN] --> F[(DB Parameters \n of Control Valves)]
  F --> H{3. Select CVs with \n Kvs > 1.3* Min.Kvs}
  
  H-. NO .-> A
  
  H-- YES --> I(4. Calc. Kv/Kvs and \n valve position for all \n data operation and Types of valves.)
  
  I --> J(Select valve.)
```

:::{.callout-note}
  - CV: Control Valve
  - Kv: Flow coefficient
  - Kvs: Maximum flow coefficient
  - Kv/Kvs : relative flow coefficient
:::


## First step: Collection of the operations data for the control valve.

-   Medium: `r data$medium`.

-   Medium Temperature: `r data$temp` $°C$.

-   Localization of the valve: `r data$masl` meters above sea level.

-   Valve Diameter: `r data$dn` $mm$

-   Diameter Upstream Pipe `r data$d1` $mm$

-   Diameter Downstream Pipe `r data$d2` $mm$

-   Relative density `r round(water_density(data$temp)/1000,2)`

```{r}
#| label: tbl-base_data
#| tbl-cap: "Operations Data"
#| include: true
#| echo: false

# Print Table base_data
base_data |> 
  select(
    condition, p1, p2, dp, flow, kv, 
    velocity, zeta, sig_1, sig_2
  ) |> 
  mutate(across(where(is.numeric), round, 2)) |>
  
  gt(rowname_col = "condition") |> 
  
  tab_row_group(
    label = "Min.Condition",
    rows = matches(".min")
  ) |> 
  
  tab_row_group(
    label = "Max.Condition",
    rows = matches(".max")
  ) |> 
  
  tab_header(
    title = md("**Operations Data**"),
    subtitle = md("Plus Calculated Data")
  ) |> 
  
  tab_spanner(
    label = "Supplied data",
    columns = c(p1,	p2,	dp,	flow)
  ) |> 
  tab_spanner(
    label = "Calculated Data",
    columns = c(kv,	zeta,	 velocity,	sig_1,	sig_2)
  ) |> 
  
  cols_label(
    p1    = html("<i>P<sub>1</sub><br>(bar)</i>"),
    p2    = html("<i>P<sub>2</sub><br>(bar)</i>"),
    dp    = html("<i>&Delta;P<br>(bar)</i>"),
    flow  = html("<i>Flow<br>(m<sup>3</sup>/h)</i>"),
    kv       = html("<i>K<sub>v</sub><br>(m<sup>3</sup>/h)</i>"),
    zeta     = html("<i>&zeta;<br>(-)</i>"),
    velocity = html("<i>Vel.<br>(m/s)</i>"),
    sig_1    = html("<i>&sigma;<sub>1</sub><br>(-)</i>"),
    sig_2    = html("<i>&sigma;<sub>2</sub><br>(-)</i>")
  ) |> 
  
  tab_source_note(
    source_note = "Source: Data of the hydraulic analysis of the system"
  ) |> 
  
   tab_footnote(
    footnote = md("The **maximum** flow coefficient."),
    locations = cells_body(
      columns = kv,
      rows = kv == max(kv)
    )
  ) |> 
  
  
  opt_stylize(style = 6, color = "gray")

```

**Columns definitions:**

-   $P_1$: Upstream static (gauge) pressure in $(bar)$;
-   $P_2$: Downstream static (gauge) pressure in $(bar)$;
-   $Flow$: Volumetric flow rate in $(m^3/h)$;
-   $(\Delta{P})$: Differential pressure between upstream and downstream pressure taps in $bar$;
-   $K_v$: Flow coefficient $(m^3/h)$; $K_v = q \cdot \sqrt{\frac {(\rho / \rho_{0})}{\Delta P}}$
-   $Vel.$ : Velocity in $m/s$
-   $\zeta$: Zeta Value; Required Velocity head loss coefficient;
-   $\sigma_1$: Cavitation index equal to $(P_2 - P_v)/\Delta{P} = (\sigma - 1)$ at service conditions;
-   $\sigma_2$: Cavitation index equal to $(P_2 - P_v)/(\Delta{P}+v^2/2g)$ at service conditions.

## Second step: select the minimum $K_v$ required.

  - The maximum flow coefficient $K_v$ required for operation of the control valve is: `r round(max(base_data$kv),2)` $m^3/h$.
  - The control valve to be selected must meet at least $1.3$ times the maximum flow coefficient required. 
  - Therefore the minimum $K_{vs}$ (full open flow coefficient) of the selected valve must be: `r round(max(base_data$kv*1.3),2)` $m^3/h$.
  

## Third step: Select the valves plus dissipation element that meet the minimum required flow coefficient.

For this exercise, we will assume the following:

  1. We only have three valves from 3 different suppliers. Brands "A", "B" and "C" 
  2. that the required valves should not have anti-cavitation cylinders.
  3. The parameters for the curve $K_v/K_{vs}$, the Zeta value $\zeta_{vs}$ and the Liquid pressure recovery factor $F_{Ls}$[^1] are available.[^2]
  4. $K_v/K_{vs} = \frac{d}{1 +\exp(b\cdot(\log{(vp)}-\log{(e)}))}$

The parameters corresponding to the valves are the following:[^3]

```{r}
#| label: tbl-parameter
#| tbl-cap: "Valve's Parameter"
#| include: true
#| echo: false
#| 

param_valves <- tribble(
  ~brand,  ~kv_b, ~kv_d,  ~kv_e, ~zvs,  ~fls,
     "A", -2.976, 1.409, 74.073, 3.39, 0.667,
     "B", -3.299, 1.561, 83.924, 7.60, 0.832,
     "C", -2.926, 1.527, 80.354, 1.90, 0.617
)

param_valves <- param_valves |> 
  mutate(kvs = kv_value(data$dn, zvs))

# Print Table with the parameter of the Valves (Brands A, B and C)
param_valves |>
  gt() |>
    cols_label(
      brand = html("Brand"),
      kv_b = html("<i>b</i>"),
      kv_d = html("<i>d</i>"),
      kv_e = html("<i>e</i>"),
      zvs  = html("<i>&zeta;<sub>vs</sub></i>"),
      fls  = html("<i>F<sub>Ls</sub></i>"),
      kvs  = html("<i>K<sub>vs</sub><br>(m<sup>3</sup>/h)</i>")
    )|> 

  tab_header(
    title = md("**For Valves DN-200 Millimeter and PN-25**"),
  ) |> 
  
  tab_spanner(
    label = html("<i>Parameter for ( K<sub>v</sub> / K<sub>vs</sub> )"),
    columns = c(kv_b, kv_d, kv_e)
  ) |> 
  
  fmt_number(
    columns = kvs,
    decimals = 1,
    suffixing = FALSE
  ) |> 

  opt_stylize(style = 6, color = "gray")

```


:::{.callout-note}
As can be seen in table 2, all the selected valves (Brand A, B, and C) comply with a flow coefficient of a $K_{vs} \geq$ `r round(max(base_data$kv),2)` $m^3/h$ required for the operation.
:::

## Fourth step: Position valves for the different operation scenarios and valve brands.

```{r}
#| label: calculation_tbl-full_data
#| include: true
#| echo: false
#| 

full_data <- tidyr::crossing(param_valves, base_data) |> 
  mutate(kv_kvs = .data$kv/.data$kvs,
         position = pmap_dbl(list(.data$kv_kvs, .data$kv_b, .data$kv_d, .data$kv_e), ~inv_LL3(..1, ..2, ..3, ..4))) |> 
  mutate(sig_i     = sigma_i( .data$position, .data$kv_b, .data$kv_d, .data$kv_e, .data$fls),
         Sig_c     = sigma_c( .data$position, .data$kv_b, .data$kv_d, .data$kv_e, .data$fls),
         Sig_mv    = sigma_mv(.data$position, .data$kv_b, .data$kv_d, .data$kv_e, .data$fls),
         cav_index = cavtation_index(.data$position, .data$kv_b, .data$kv_d, .data$kv_e, .data$fls, .data$sig_2),
         regime    = cavtation_regime(.data$position, .data$kv_b, .data$kv_d, .data$kv_e, .data$fls, .data$sig_2)) |> 
  select(brand,	condition, kv_b,	kv_d,	kv_e,	zvs,	fls,	kvs,	p1,	p2,	flow,	
         dp,	velocity,	kv, kv_kvs,	position, zeta,	sig_0,	sig_1,	sig_2, 
         sig_i, Sig_c, Sig_mv, cav_index, regime)

```

### Brand A:
```{r}
#| label: positio_valve_operation
#| tbl-cap: "Valves position for the different operations scenarios."
#| include: true
#| echo: false
#| 
# Table Valves and operation's data
full_data |>   filter(brand == "A") |> 
  select(condition, p1,	p2,	flow, kv, kv_kvs, position, sig_2, regime) |> 
  mutate(kv_kvs = kv_kvs*100) |> 
  mutate(across(where(is.numeric), round, 2)) |>
  
  gt(rowname_col = "condition") |> 
  tab_row_group(
    label = "Min.Condition",
    rows = matches("*.min")
  ) |> 
  
  tab_row_group(
    label = "Max.Condition",
    rows = matches("*.max")
  ) |> 
  
  cols_label(
    p1    = html("<i>P<sub>1</sub><br>(bar)</i>"),
    p2    = html("<i>P<sub>2</sub><br>(bar)</i>"),
    flow  = html("<i>Flow<br>(m<sup>3</sup>/h)</i>"),
    kv       = html("<i>K<sub>v</sub><br>(m<sup>3</sup>/h)</i>"),
    kv_kvs   = html("<i>K<sub>v</sub> / K<sub>vs</sub><br>(%)</i>"),
    position = html("<i>Position<br>(%)</i>"),
    sig_2    = html("<i>&sigma;<sub>2</sub><br>(-)</i>"),
    regime   = html("<i>Cavitation<br>Regime</i>")
  )
  
```

* Cavitation and non-cavitation regime

[^1]: Liquid pressure recovery factor of a control valve without attached fittings (ISA-75.01.01-2007: Flow Equations for Sizing Control Valves).
[^2]: In the next blogs we will see how these values can be calculated from the documents supplied by the suppliers.
[^3]: These parameters are similar to those in reality but adjusted for this Example.


# References

::: {#refs}
:::
